---
title: "EVSI ranking two asset problem"
output: pdf_document
---

###Priors

Let $A$ and $B$ be two assets. Each has some value $\theta_a$ and $\theta_b$, both of which are uncertain with prior probability distributions,

$$\theta^\prime_a\sim\mathcal{N}(\mu^\prime_a, \tau^\prime_a)~~~~~~~~~~~~~~~(1)$$

and

$$\theta^\prime_b\sim\mathcal{N}(\mu^\prime_b, \tau^\prime_b)~~~~~~~~~~~~~~~(2)$$

where $\mu^\prime_a$ and $\mu^\prime_b$ are the prior means and $\tau^\prime_a$ and $\tau^\prime_b$ are the prior precisions. 

Let $\pi^\prime=\Pr(\theta_a > \theta_b)$ and therefore,

$$\pi^\prime = \Phi\left(\frac{\mu^\prime_a-\mu^\prime_b}{\sqrt{\tau^{\prime-1}_a+\tau^{\prime-1}_b}}\right)~~~~~~~~~~~~~~~(3)$$

###Utilities

If $\pi^\prime > 1 - \pi^\prime$ then the optimal action is to purchase asset $A$, otherwise it is to purchase $B$.

We can assign utilities to each combination of the condition of $\theta_a$ and $\theta_b$, and each action such that,

$$ 
\begin{aligned}
u(\theta_a > \theta_b, A)&=1\\
u(\theta_a < \theta_b, A)&=0~~~~~~~~~~~~~~~(4)\\
u(\theta_a > \theta_b, B)&=0\\
u(\theta_a < \theta_b, B)&=1\\
\end{aligned}
$$

Therefore the expected values of taking each action are $\mathrm{E}[u(A)]=\pi^\prime$ and $\mathrm{E}[u(B)]=1-\pi^\prime$.

###Value of perfect information

If we could reduce the uncertainty in the prior probabilites of $\theta_a$ and $\theta_b$ such that $\pi^\prime$ approached either limit, then the expected value of perfect information is,

$$\mathrm{EVPI}=1-\max(\pi^\prime, 1-\pi^\prime)=\min(\pi^\prime, 1-\pi^\prime)~~~~~~~~~~~~~~~(5)$$

###Preposterior analysis

Now let's assume we can sample from some process and learn about $\theta_a$ and $\theta_b$.  
Let $X_a$ and $X_b$ be observations from a process described by the following sampling distributions,

$$X_a\sim\mathcal{N}\left(\theta_a, \tfrac{1}{\sigma^2}\right)~~~~~~~~~~~~~~~(6)$$

and

$$X_b\sim\mathcal{N}\left(\theta_b, \tfrac{1}{\sigma^2}\right)~~~~~~~~~~~~~~~(7)$$

where for simplicity $\sigma$ is some fixed and known standard deviation.

Furthermore, we can make $n_a$ and $n_b$ observations of $X_a$ and $X_b$ respectively.
Given the observations of $X_a$ and $X_b$ with sample sizes $n_a$ and $n_b$ we can update the prior beliefs in $\theta_a$ and $\theta_b$ and arrive at posterior distributions,

$$ 
\begin{aligned}
\theta^{\prime\prime}_a &\sim \mathcal{N}(\mu^{\prime\prime}_a, \tau^{\prime\prime}_a)~~~~~~~~~~~~~~~(8)\\
\theta^{\prime\prime}_b &\sim \mathcal{N}(\mu^{\prime\prime}_b, \tau^{\prime\prime}_b)
\end{aligned}
$$
where,
$$
\begin{aligned}
\mu^{\prime\prime}_a&=\frac{X_a}{\tfrac{\tau^\prime_a\sigma^2}{n_a}+1}+\frac{\sigma^2\mu^\prime_a}{\sigma^2+\tfrac{n_a}{\tau^\prime_a}}\\
\tau^{\prime\prime}_a&=\frac{\tau^\prime_a\sigma^2+n_a}{\sigma^2}~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~(9)\\
\mu^{\prime\prime}_b&=\frac{X_b}{\tfrac{\tau^\prime_b\sigma^2}{n_b}+1}+\frac{\sigma^2\mu^\prime_b}{\sigma^2+\tfrac{n_b}{\tau^\prime_b}}\\
\tau^{\prime\prime}_b&=\frac{\tau^\prime_b\sigma^2+n_b}{\sigma^2}
\end{aligned}
$$

###Value of sample information

Now we make the simplifying assumptions that $\mathrm{E}[X_a]=\mathrm{E}[\theta_a]=\mu^\prime_a$ and $\mathrm{E}[X_b]=\mathrm{E}[\theta_b]=\mu^\prime_b=0$. And instead of sampling with $n_a$ and $n_b$ we set the total sample size at $N$ and set $n_a=Np$ and $n_b=N(1-p)$ so that $p$ is the proportion of total sampling allocated to learning about asset $A$.

In this scenario the prior probability of $\theta_a>\theta_b$ is,
$$\pi^\prime=\Phi\left(\frac{\mu^\prime_a}{\sqrt{\tau^{\prime-1}_a+\tau^{\prime-1}_b}}\right)~~~~~~~~~~~~~~~(10)$$

, and the posterior is

$$\pi^{\prime\prime}=\Phi\left(\frac{\mu^\prime_a}{\sqrt{\left(\frac{\sigma^2}{\tau^\prime_a\sigma^2+Np}\right)+\left(\frac{\sigma^2}{\tau^\prime_b\sigma^2+N(p-1)}\right)}}\right)~~~~~~~~~~~~~~~(11)$$

We can now calculate the expected value of sample information,

$$\mathrm{EVSI}=\max(\pi^{\prime\prime}, 1-\pi^{\prime\prime})-\max(\pi^\prime, 1-\pi^\prime)~~~~~~~~~~~~~~~(12)$$

###Optimal sampling allocation

With equations 10-12, for any given set of $\mu^\prime_a$, $\tau^\prime_a$, $\mu^\prime_b$, $\sigma$ and $N$ we can find the optimal allocation to sample for asset $A$, $p$ to maximise the value of sample information.

```{r, echo=FALSE}
EVPI <- function(mu_a, tau_a, tau_b) {
  PI <- pnorm(mu_a / (sqrt(2) * ((tau_a^-.5) + (tau_b^-.5))))
  pmin(PI, 1 - PI)  
}

EVSI <- function(mu_a, tau_a, tau_b, sigma2, N, p) {
  PI <- pnorm(mu_a / (sqrt(((1 / tau_a) + (1 / tau_b)))))
  
  PI_prime <- pnorm(mu_a / sqrt((sigma2 / (tau_a * sigma2 + N * p)) + 
    (sigma2 / (tau_b * sigma2 + N * (1 - p)))))
    
  pmax(PI_prime, 1 - PI_prime) - pmax(PI, 1 - PI)
}

EVSI_opt <- function(mu_a, tau_a, tau_b, sigma2, N) {
  sapply(N, 
    function(N) {   
      optimize(
        function(p) {
          EVSI(mu_a, tau_a, tau_b, sigma2, N, p)
        },             
        interval=c(0, 1), maximum=TRUE
      )
    }
  )
} 

plot_EVSI_rank <- function(mu_a=1, tau_a=.001, tau_b=5, N=2000, sigma2=100, p=.5) {
  EVPI_ <- EVPI(mu_a=mu_a, tau_a=tau_a, tau_b=tau_b)
  EVSI_ <- EVSI(mu_a=mu_a, tau_a=tau_a, tau_b=tau_b, sigma2=sigma2, N=0:N, p=p)
  EVSI_opt_ <- EVSI_opt(mu_a=mu_a, tau_a=tau_a, tau_b=tau_b, sigma2=sigma2, N=0:N)
  
  par(mfcol=c(2, 2), mar=c(1, 1, 0, 0), oma=c(4, 3.5, 1, 5))
  
  plot.new()  
  plot.window(xlim=c(0, N), ylim=c(0, 1.05))
  box()
  axis(2, las=1)
  mtext('p', side=2, line=3, las=1, font=3)
  abline(h=p, lwd=2, col='grey', lty=2)
  optP <- unlist(EVSI_opt_[1, ])[-1]
  points(1:N, optP, type='l', lwd=2)
  optP <- round(pmax(optP, 1 - optP), 3)
  maxOptP_N <<- which.max((1:N)[optP == max(optP)])
  if (tau_a == tau_b) maxOptP_N <<- 0
  abline(v=maxOptP_N, col='red')
  text(maxOptP_N, 1, maxOptP_N, pos=4, col='red')
  mtext('a ', side=3, line=-1.3, adj=1)

  plot.new()  
  plot.window(xlim=c(0, N), ylim=c(0, .57))
  box()
  axis(1)
  axis(2, las=1)
  mtext('N', side=1, line=2.5, font=3)
  mtext('--- p=optimum', adj=0, side=1, line=3.5, col='red')
  mtext(sprintf('--- p=%s', p), adj=1, side=1, line=3.5, col='black')
  mtext('EVSI', side=2, line=3)
  abline(h=EVPI_, lwd=2)
  points(0:N, EVSI_, type='l', lwd=2, lty=3)
  points(0:N, unlist(EVSI_opt_[2, ]), type='l', lty=2, col='red')
  text(0, EVPI_, sprintf('                         EVPI = %s', round(EVPI_, 3)), pos=3)
  mtext('c ', side=3, line=-1.3, adj=1)

  plot.new()  
  plot.window(xlim=c(0, 4), ylim=c(min(mu_a - 2.5 * (tau_a^-.5), -2.5 * (tau_b^-.5)), 
    max(mu_a + 2.5 * (tau_a^-.5), 2.5 * (tau_b^-.5))))
  box()
  axis(4, las=1)
  segments(c(1.5, 3.5), c(mu_a - 1.96 * (tau_a^-.5), -1.96 * (tau_b^-.5)), 
    y1=c(mu_a + 1.96 * (tau_a^-.5), 1.96 * (tau_b^-.5)))
  points(c(1.5, 3.5), c(mu_a, 0), pch=19)
  text(1.5, mu_a, bquote({mu*"'"}[a]==.(round(mu_a, 3))), pos=2, font=3)
  text(3.5, 0, bquote({mu*"'"}[b]==0), pos=2, font=3)
  text(.5, min(mu_a - 2.5 * (tau_a^-.5), -2.5 * (tau_b^-.5)) / 2, 
    bquote(sigma == .(sqrt(round(sigma2, 1)))))
  mtext('b ', side=3, line=-1.3, adj=1)
  
  plot.new()  
  plot.window(xlim=c(0, N), ylim=c(0, max(unlist(EVSI_opt_[2, ]) - EVSI_, .001) * 1.2))
  box()
  axis(1)
  axis(4, las=1)
  mtext('N', side=1, line=2.5, font=3)
  mtext(bquote('EVSI'^'p=optimum' - 'EVSI'^.(paste('p =',p))), side=4, line=4)
  optN <<- (0:N)[which.max(unlist(EVSI_opt_[2, ]) - EVSI_)]
  if (tau_a == tau_b) optN <<- 0
  abline(v=optN, col='red')
  text(optN,
    max(unlist(EVSI_opt_[2, ]) - EVSI_, .001) * 1.18, 
    round(optN), col='red', pos=4)
  abline(h=max(unlist(EVSI_opt_[2, ]) - EVSI_), col='blue', lty=4)
  text(0, max(unlist(EVSI_opt_[2, ]) - EVSI_),  
    bquote('                                                   EVSI'^
      'p=optimum' - 'EVSI'^.(paste('p =',p)) == 
      .(round(max(unlist(EVSI_opt_[2, ]) - EVSI_), 3))),
    pos=3, col='blue')
  points(0:N, unlist(EVSI_opt_[2, ]) - EVSI_, type='l', lwd=3) 
  mtext('d ', side=3, line=-1.3, adj=1)
 
} 

```
### $\mu_a > \mu_b, \tau_a \ll \tau_b, \sigma=10$

First let's examine the case where our prior belief is that $\theta^\prime_a$ is somewhat greater than $\theta^\prime_b$, where $\mu^\prime_a = 1$ and $\mu^\prime_b = 0$ but the uncertainty in $\theta^\prime_a$ is far greater than in $\theta^\prime_b$, $\tau^\prime_a = .001$ and $\tau^\prime_b = 5$. In addition we will assume that the sampling distributions for $X_a$ and $X_b$ have high variance, $\sigma=10$. 

```{r, echo=FALSE}
plot_EVSI_rank(mu_a=1, tau_a=.001, tau_b=5, N=2000, sigma2=100, p=.5)
```

In this case, until we can take more than a total of `r maxOptP_N` samples ($N=`r maxOptP_N`$) the optimal allocation is to allocate all sampling effort to asset $A$ (a). With a total budget greater than `r maxOptP_N` samples, we start allocating sampling to asset $B$ at a diminishing rate with total sample size and asymptoting at $p=0.5$. The expected value of sample information (EVSI) increases with sample size with diminishing returns asymptoting at the EVPI (c). At all sample sizes, the optimal allocation has greater expected value than naive assumption of constant allocation of $p=0.5$. The greatest benefit of allocating optimally is when the sample size is $N=`r optN`$. As sample size increases the additional benefit of allocating optimally declines asymptotically as the optimal allocation approaches $p=0.5$ (d).

<hr>

### $\mu_a \simeq \mu_b, \tau_a \ll \tau_b, \sigma=10$

Holding all the other parameters constant, let's examine a scenario where the prior expection of $\theta^\prime_a$ is only marginally better than $\theta^\prime_b$ (i.e., reduce $\mu^\prime_a$ to $\mu^\prime_a=.01$). 

```{r, echo=FALSE}
plot_EVSI_rank(mu_a=.01, tau_a=.001, tau_b=5, N=2000, sigma2=100, p=.5)
```

We still allocate in the same way as before (a). The EVPI approaches its theoretical maxmimum of 0.5. But the value of sample information achievable for anything less than 2000 samples is reduced to near zero (c). The shape of the additional benefit from optimal allocation is the same but the scale has reduced and the optimal value of N has increased meaning more samples must be taken to maxmise the additional gain in EVSI by using the optimal allocation vs the naive allocation of $p=0.5$ (d). 

<hr>

### $\mu^\prime_a \gg \mu^\prime_b, \tau^\prime_a \ll \tau^\prime_b, \sigma=10$

All other parameters still the same, but now with $\mu^\prime_a=2$ much greater than $\mu^\prime_b$.

```{r, echo=FALSE}
plot_EVSI_rank(mu_a=2, tau_a=.001, tau_b=5, N=2000, sigma2=100, p=.5)
```

Still same optimal allocation (a). EVPI reduced as we start already more certain that $A$ is a better asset than $B$. The return on investing in each additional sample diminishes quicker and sooner as EVSI asymptotes at EVPI (c). The additional benefit in EVSI seen by sampling optimally has increased by peaks earlier at $N=`r optN`$ (d).

<hr>

### $\mu^\prime_a > \mu^\prime_b, \tau^\prime_a < \tau^\prime_b, \sigma=10$

Resetting $\mu^\prime_a$ now we examine what happens when $\tau^\prime_a$ is only half $tau^\prime_b$.

```{r, echo=FALSE}
plot_EVSI_rank(mu_a=1, tau_a=2.5, tau_b=5, N=2000, sigma2=100, p=.5)
```

The optimal allocation has the same shape as before but now we allocate sampling to asset $B$ sooner than before. Now if we take more than `r maxOptP_N` samples we will allocate an increasing amount of them to asset $B$ (a). The EVPI has been greater reduced as we have started off more certain the $A$ is greater $B$ (c). There is less adavantage to sampling optimally rather than the naive allocation but the point at which the additional benefit in EVSI peaks is at higher $N$ ($N=`r optN`$) than when $\tau^\prime_a$ was much less than $\tau^\prime_b$ (d).   

<hr>

### $\mu^\prime_a > \mu^\prime_b, \tau^\prime_a = \tau^\prime_b, \sigma=10$

Now increase the precision of $\theta^\prime_a$ so that $\tau^\prime_a = \tau^\prime_b$.

```{r, echo=FALSE}
plot_EVSI_rank(mu_a=1, tau_a=5, tau_b=5, N=2000, sigma2=100, p=.5)
```

Now the optimal allocation is to just allocate evenly between the assets (i.e., the naive allocation is now optimal and there is effectively no advantage to optimize) (a). The allocation is still insentive to the value of $\mu^\prime_a$ and the value of $\tau$'s. Decreasing the prior precisions increases EVPI, and with it the point at which EVSI vs $N$ asymptotes, but without changing the rate EVPI increases with $N$. Increaseing the value of $\mu^\prime_a$ decreases EVPI (but less sensitively than changing the precision) and also increases the rate at which EVPI vs $N$ approaches EVPI (c).

<hr>

### $\mu^\prime_a > \mu^\prime_b, \tau^\prime_a \gg \tau^\prime_b, \sigma=10$

Returning to the original paramterisation now reverse the prior precisions so that $\tau^\prime_a$ is much greater than $\tau^\prime_b$.

```{r, echo=FALSE}
plot_EVSI_rank(mu_a=1, tau_a=5, tau_b=.001, N=2000, sigma2=100, p=.5)
```

The allocation is the same but now reflected so that we still allocate to the asset with more uncertainty (a). This applies no matter what the other parameter values are (i.e., the problem is symetrical)

<hr>

### $\mu^\prime_a > \mu^\prime_b, \tau^\prime_a \ll \tau^\prime_b, \sigma=5$

Now decrease the standard deviation of the sampling distributions of $X_a$ and $X_b$. 

```{r, echo=FALSE}
plot_EVSI_rank(mu_a=1, tau_a=.001, tau_b=5, N=2000, sigma2=25, p=.5)
```

The optimal allocation changes so that you start allocating to the more certain asset at smaller $N$ (a). The value of $N$ at which you start allocating to more than one asset is linearly related to the variance of the sampling distributions $\sigma^2$ when the ratio of the prior precisions is fixed. EVPI is insenstive to changes in $\sigma$ as it is only dependant on the prior knowledge. The rate at which EVSI increases with $N$ is negatively related to $\sigma$ as the information per sample is greater when the sampling distribution has lower variance (c). The scale of the performance gain when allocating optimally is insensitive to changes in $\sigma$. However, the point at which optimality is most advantageous is at lower $N$ when $\sigma$ is reduced, and the additional benefit of allocating optimally declines quicker as we learn at a faster rate and optimal $p$ approaches 0.5 sooner. 

### Summary

* Optimal allocation insensitive to ratio of $\mu_a$ to $\mu_b$.
* Optimal allocation sensitive to ratio of $\tau_a$ to $\tau_b$.
* Always preferential to sample asset with greater uncertainty.
* Solution is symetrical.
* The $N$ at which you start to allocate sampling to both assets is proportional to the ratio of $\tau_a$ to $\tau_b$.
* The $N$ at which you start to allocate sampling to both assets is proportional to the variance of the sampling distribution.
* The $N$ at which you start to allocate sampling to both assets is insensitive to whether  $\tau_a < \tau_b$ or $\tau_a > \tau_b$.
* Optimal allocation always has greater EVSI when $\tau_a \neq \tau_b$.
