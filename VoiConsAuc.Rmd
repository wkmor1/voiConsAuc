---
title: "The value of information for conservation auctions"
author: "William K Morris"
documentclass: article
output: bookdown::html_document2
---
```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  cache = TRUE, echo = FALSE, message = FALSE, warning = FALSE, results = "hide"
)
```

```{r pkgs}
library(mgcv)
library(mvtnorm)
library(parallel)
library(raster)
```

<!----------------------------------PLAN----------------------------------------

{} Abstract

{} Introduction

   -- Conservation auctions and VOI (Motivation) 

   -- Reverse Auctions
      ** Some background stuff on conservation auctions and PES schemes
      ** Examples like Bush Returns, Bush Tender, CRP, European examples etc
   
   -- Rank by cost-benefit
      ** The typical way of deciding on the outcome of bidding
      ** It's not necessarily optimal 
      
   -- Conservation auctions and uncertainty
      ** Uncertainty in benefits 
      ** Uncertainty in costs
      ** Uncertainty is often ignored by agencies
      ** Contrast with the game-theoritic and economic literature

   -- VOI

{}  Analysis 
   
   -- Analytical context
      ** Set up the model 
   
   -- Our Approach
      ** Optimal Solution for two asset
      ** Simulation of  two asset 
      ** Simulation of three or more asset
      ** Heuristic for two asset
      ** Heuristic for three asset
      ** How is it similar/different to other approaches, game-theoritic, 
         multi-armed bandit, bayesian experimental design
         
{} Discussion

      ** Heuristics/rules of thumb from that can be applied to real world
      ** Comparison of naive to optimal
      ** Rules of thumb
         *** Learn first at the margin
         *** Learn about the most uncertain
         *** Learn last about the rest until the budget is exhausted
      
{} Conclusions

{} 4 graphics

   -- Figure 1 Optimal solution for 2 assets
   -- Figure 2 Simulated solution for 2 assets
   -- Figure 3 Heuristic solution for 3 assets
   -- Figure 4 Simulated solution for 3 assets
   
------------------------------------------------------------------------------->

# Abstract {-}
Conservation auctions can been used to meet the objectives of natural resource managers and are designed to cost-effectively protect biodiversity and ecosystem services. In running an auction, an agency seeks to minimize the cost it pays to get the maximum benefit from the assets bought in the auction. When the auction is completed, cost (the total cost of the winning bids) tends to be known with certainty. Often however, benefits are more uncertain (e.g., when the benefits are to be realized in the future, such as in the case of vegetation regeneration). Therefore, there is an imperative on the part of the auction-running agency to spend resources on learning about benefits in order to make a decisions about which bids will be successful and which bids will be unsuccessful. Here we use the concept of expected value of sample information to assess how such an agency should allocate a limited learning budget among bids in order to conduct a conservation auction that yields the most cost-effective return on investment. We propose a simple model system where an agent has two or more assets among which they must pick the most cost-effective to invest in, for a forthcoming auction. The cost-effectiveness of each asset is more or less uncertain and there is some budget allocated to reduce the uncertainty of each asset. The agent must decide how to allocate the learning budget among the assets in order to maximize the expected benefit of the auction. We describe an analytical solution to the problem when there are two assets and the uncertainty in cost-effectiveness is normally distributed. When there are more the two assets in the auction pool, then the analytical solution does not apply. Instead, we propose a heuristic solution to the problem based on optimally ranking the assets in order of cost-effectiveness (rather than knowing explicitly, the exact value that determines the ranks). We then compare results of the heuristic solution to a Monte Carlo simulation of the problem to demonstrate that it arrives at the same optimal allocation of learning resources. In applying our model to case-studies with different numbers of assets and with different prior knowledge of the assets cost-effectiveness, we glean a number of rules-of-thumb that may be helpful to agencies conducting conservation auctions. When learning budgets are small then the most optimal strategy is to learn new information about the most marginal assets, that is, the assets about which the probability of being the most cost-effective is the most uncertain. Then, as the budget increases it becomes more optimal to learn about assets which have uncertain cost-effectiveness in the more general sense. Finally, as learning budgets become large enough as to not be limiting, resources can be allocated evenly across all uncertain assets. The model we propose and the analytical, heuristic and simulation solutions we apply to its case studies, imply that naive even allocation (or no allocation at all) to learning among assets in a conservation auction may lead to less than cost-effective outcomes for the agencies that use them.

# Introduction {-}
Conservation auctions have become a widespread and established market mechanism aimed at achieving public environmental good by contracting with landholders and managers cost-efficiently. Conservation auctions include payment for ecosystem services (PES) schemes, environmental stewardship and conservation easement programs. Some recent examples include the US Water Quality Incentives Program, the Conestoga watershed reverse auctions of Pennsylvania, the English Countryside Stewardship Scheme, the German MEKA project and the Bush Returns and Bush Tender programs in Victoria, Australia.

Uncertainty about the benefits resulting from a conservation auction investment is not often addressed. Ignoring uncertainty may be foregoing untapped benefit in the implementation of a conservation auction. If the uncertainty in a conservation auction was reduced then it could potentially be implemented with greater cost-efficiency than it would otherwise. Here we consider the uncertainty in a conservation auction and how resources should be allocated among the assets that are candidates for investment to seeking information. We use the concept of expected value of sample information (EVSI) and simple auction model to discover the best strategy to allocate resources to learning in a conservation auction.

## Reverse auctions {-}
Conservation auctions typically take the form of a reverse auction. In a reverse auction, the agency conducting the auction, usually a branch of a government, is the buyer. The bidders are the landholders or land-managers who compete for the pool of funding available by offering to sell some prespecified environmental good desired by auction-conducting agency. The environmental good may take the form of land title or a contract to conduct a particular management action. In some cases the outcome of management is the good specified in the contract and the management action is left up to the managers. Unlike a standard auction where the buyers are competing and price is maximized, reverse auctions are aimed at reducing the price of the goods being purchased, as it is the sellers how are in competition with one another. In facilitating the competition for a single pool of funding the auction conducting agent seeks to maximize the environmental benefit it can get for the lowest cost and thus maximize the cost-effectiveness of the environmental scheme.

## Ranking auction bids by cost-benefit ratio {-}
In a typical reverse auction, aimed at getting some public environmental good, the conducting agency will assess the bids by their cost-benefit ratio. The bids will be ranked from highest to lowest in terms of cost efficiency. The winning bids will be the most cost-efficient up to some cutoff. The cutoff may be the cumulative total cost of the most cost efficient bids measured against a fixed budget, or it could be a prespecified level of cost-efficiency. Time-limited reverse auctions will often use the budget exhaustion method whereas longer-term schemes with repeated rounds might use a cost-efficiency based cutoff. The
rank-by-cost-efficient strategy is usually near optimal though in some circumstances it can produce non-optimal results and more sophisticated portfolio methods can be used to maximize the total benefit. However, frequently the more complex methods yield similar results to a simple ranking and budget exhaustion strategy.

## Conservation auctions and uncertainty {-}
There are multiple sources of uncertainty in a conservation auction that can affect the outcome in a number of ways. Moreover, there a multiple perspectives from which to view uncertainty within the framework of a conservation auction, and the different actors may be affected by different uncertainties about different aspects of the auction. Here we focus only one aspect of uncertainty, uncertainty about the cost-efficiency of bids and only from the perspective of the agency conducting the auction. Other important facets of uncertainty in reverse-auctions, are the knowledge bidders have of one another's circumstances and intentions and the circumstances of the seller. There is a vast game-theoretic literature dealing with these types of uncertainty in auctions, but we don't deal with them further here.

After the bids are submitted in an auction, that component of the auction cost will have no uncertainty. So in most conservation auctions the bulk of the uncertainty about cost-efficiency is due to uncertainty about benefits. Conservation benefit of the kind sought after in a reverse auction is inherently uncertain as it is often only realized at some point far in future, long after the auction scheme is implemented. Land regeneration, water or soil quality improvement, or other ecosystem services are some examples of the type of benefit that is payed for at one point in time, while the payoff is not expected until much later on. This time-lag in return on investment makes the cost-efficiency of auction bids uncertain. Uncertainty in the individual auction bids then leads to a neccessary uncertainty in their ranking. And therefore, the uncertainty in benefits flows through to the cost-efficiency and to the total benefit realised for the conservation auction scheme. 

## The value of information {-}
Given that the outcome of many conservation auctions maybe uncertain, it way be wise for an auction conducting agency to invest resources in learning about the benefits before they rank the assets and determine the winning bids. If they can increase the probability of correctly ranking the bids in order of cost-efficiency, they could avoid investing in unwarranted assets and increase the total benefits realised after the auction is completed. The performance gain one might expect after learning and a subsequent reduction in uncertainty is known as the expected value of information (EVI). Decision makers can use an EVI analysis to predetermine the worth of learning about the outcome a decision problem such as a conservation. A type of EVI is the expected value of sample information, EVSI, which is the value of reducing uncertainty by some degree, by collecting a sample of data, as opposed to eliminitating uncertainty completely, which is the expected value of perfect information (EVPI). 

Using the concept of EVSI a conservation auctioneer could work out if it would be worthwhile collecting data to learn about the benefits of a conservation auction and even how much data would be most to appropriate to collect. Here we extend the idea of expected value of sample information for a conservation auction and consider how to allocate the uncertainty reducing sample of information among the different assets for sale in the auction. The naive solution to problem is simply to allocate learning evenly among the assets and reducing the uncertainty about the benefits of each by the same degree. However, depending on the particular circumstances of the initial levels of uncertainty this may not be the most optimal allocation of learning resources. 

# Analysis {-}
## The Model {-}
Here we describe a simple model of a conservation auction where the cost-efficiency of each asset in the auction pool is uncertain. In our model there are, $n>1$, assets. The $i^{th}$ ($i = 1...n$) asset's cost-efficiency is described by a normal distribution with mean, $\mu_i$ and standard deviation, $\sigma_i$. There are two seperate budgets, one for investing in assets in the reverse auction and a second budget that can be used to reduce the uncertainty about the asset's cost-efficiency. The first budget is large enough to invest in any one of the assets, while the second budget is variable and can be used to collect a sample of data about the cost-efficiency of each individaul asset. The total budget for data collection $M$, may be divided between each of the $n$ assets in the auction with a different proportion, $p_i$, allocated to each asset where $Mp_i$ is proportional to the sample-size of data collected about the cost-efficiency of the $i^{th}$ asset.

## Expected value under uncertainty  {-}
Under the initial level of uncertainty a risk-neutral auctioneer would simply rank the assets in order of their expected cost-efficiency and invest in the asset with the largest mean cost-efficiecy. This is the expected value under uncertainty or also known as the expected value with original information (EVWOI). More formally,

$$
\mathrm{EVWOI} = \max\mu_i
$$

## Expected value of sample information  {-}
Now we turn to the allocation of sampling for uncertainty reduction among the assets in the auction pool and the calculation of the expected value of sample information. In the following section we outline three solutions to the problem of calculating EVSI for the model above given a sampling budget and an allocation of the budget among the assets in the auction pool. When $n = 2$ there is analytical solution the derivation of which can be found in @Moore2017.

### Analytical solution when $n = 2$ 
When there are only two assets the EVSI (as shown by @Moore2017) is defined as,

$$
\mathrm{EVSI} = \frac{1}{2}\left(\Theta\sqrt{\frac{2}{\pi}}^{-\frac{\mu_1 - \mu_2}{2\Theta^2}} + (\mu_1 - \mu_2)\,\mathrm{erf}\left(\frac{\mu_1 - \mu_2}{\Theta\sqrt{2}}\right)\right) 
$$

where, 

$$
\Theta = \sigma^2_1\frac{Mp_1\sigma^2_1}{Mp_1\sigma^2_1 + 1} + \sigma^2_2\frac{Mp_2\sigma^2_2}{Mp_2\sigma^2_2 + 1}
$$

# Discussion {-}
Possible extensions -
Budget larger so can purchase more assets. 
More sophisticated algorithm for selecting wining bids.
Single budget for both learning and purchasing.
Different types of learning - learning about individual bids, learning about benefits in general.

# Conclusions {-}


```{r evsi2an}
erf <- function(x) 2 * pnorm(x * sqrt(2)) - 1

evi2an =
  function(m, theta) {
    ans = 
      theta * sqrt(2 / pi) * exp((-m^2) / (2 * theta^2)) +
        m * erf(m / (theta * sqrt(2))) -
          abs(m)
    ans / 2
  }

evpi2an =
  function(m = 0, sigma = c(1, 1)) {
    theta = sqrt(sum(sigma^2))
    evi2an(m, theta)
  }

evsi2an =
  function(m = 0, sigma = c(1, 1), n = c(1, 1)) {
    s     = sigma^2
    ns    = n * s
    theta = sqrt(s[1] * (ns[1] / (ns[1] + 1)) + s[2] * (ns[2] / (ns[2] + 1)))
    evi2an(m, theta)
  }
```

```{r evsi2heu}
evsi2heu <- 
  function(m = 0, sigma = c(1, 1), n = c(1, 1)) {
    tau = 1  / (sigma^2)
    p  = pnorm(m / (sqrt(2) * ((tau[1]^-.5) + (tau[2]^-.5))))
    pp = pnorm(m / (sqrt(2) * ((tau[1] + n[1])^-.5 + (tau[2] + n[2])^-.5)))
    pmax(pp, 1 - pp) - pmax(p, 1 - p)
  }
```

```{r evis2naive}
evsi2naive <-
  function(m = 0, sigma = c(1, 1), N = 1, f) {
    sapply(
      N, 
      function(x) {
        f(m, sigma, c(x / 2, x / 2))
      }
    )
  }
```

```{r evsi2opt}
evsi2opt <-
  function(m = 0, sigma = c(1, 1), N = 1, f, type = c("p", "evsi")) {
    sapply(
      N, 
      function(x) {
        optimise(
          function(p) f(m, sigma, c(x * p, x * (1 - p))), 0:1, maximum = TRUE
        )[[switch(type, p = 1, evsi = 2)]]
      }
    )
  }
```

(ref:evsi2anplot) _Analytical solution to optimal allocation of sampling of two assets. In this case two assets have prior distributions $\mathrm{N}(\mu = 1, \sigma = 1)$ and $\mathrm{N}(\mu = 0, \sigma = 1/5)$ respectively. The top panel indicates the optimal proportional allocation of sampling between the two assets (black line) as well as the naive allocation with even sampling between two assets (dashed line) . Here $p$ is the proportion allocated to the first asset and $N$ is the total number of samples (the budget). The middle panel shows the EVSI for the optimal and naive sampling strategies of the panel above. The dotted line is the EVPI (`r evpi2an(1, c(1, 1/5))`). is The bottom panel indicates the gain in EVSI of using the optimal strategy over the naive solution (the difference between the two curves in the middle panel)._

```{r evsi2anplot, fig.cap = "(ref:evsi2anplot)"}
local({
  N      = seq(0, 50, 50 / 100)
  m      = 1
  sigma  = c(1, 1/5)
  evpi   = evpi2an(m, sigma)
  p      = evsi2opt(m, sigma, N, evsi2an, "p")
  evsi   = evsi2opt(m, sigma, N, evsi2an, "evsi")
  evsi_n = evsi2naive(m, sigma, N, evsi2an)
  
  par(mfrow = c(3, 1), oma = c(5, 5, 1, 1), mar = c(.5, .5, .5, .5),
      xaxs = 'i', yaxs = 'i')
 
  plot.new()
  plot.window(xlim = range(N), ylim = 0:1, bg = "grey90")
  rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], 
       col = "grey90", border = NA)
  abline(h = .5, lty = 2)
  points(N, p, type = "l", xpd = NA)
  mtext("p", 2, 4)
  axis(2, las = 1)
  
  plot.new()
  plot.window(xlim = range(N), ylim = c(0, evpi * 1.1), bg = "grey90")
  rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], 
       col = "grey90", border = NA)
  abline(h = evpi, lty = 3)
  points(N, evsi, type = "l", xpd = NA)
  points(N, evsi_n, type = "l", lty = 2, xpd = NA)
  mtext("EVSI", 2, 4)
  axis(2, las = 1)
  
  plot.new()
  plot.window(xlim = range(N), ylim = c(0, max(evsi - evsi_n) * 1.1),
              bg = "grey90")
  rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], 
       col = "grey90", border = NA)
  points(N, evsi - evsi_n, type = "l", xpd = NA)
  mtext("EVSI gain", 2, 4)
  axis(2, las = 1)
  axis(1)
  mtext("N", 1, 3, outer = TRUE)
})
```

```{r evsi2sim, eval = FALSE}
system("julia evsi2sim.jl &")
```

```{r evsi2simplot}
local({
  sim = read.csv("evsi2sim.csv")
  sim = as.matrix(sim)
  r = raster(sim)
  y = seq(0.99, 0.01, length.out = nrow(sim))[apply(sim, 2, which.max)]
  x = seq(0.01, 0.99, length.out = ncol(sim))
  plot.new()
  plot.window(xlim = 0:1, ylim = 0:1, xaxs = 'i')
  plot(r, xaxt = "n", las = 1, useRaster = FALSE, legend = FALSE, add = TRUE, col = grey.colors(256))
  contour(r, add = TRUE)
  abline(h = 1/2, lty = 2)
  points(x, predict(gam(y~s(x))), type = "l", pch = 19, col = "black", lwd = 2)
  axis(1, seq(0, 1, length.out = 6), seq(0, 50, length.out = 6))
  axis(2, 0:5/5, las = 1)
  mtext("N", 1, 3)
  mtext("p", 2, 3)
})
```

```{r calcjp}
calc_jp = function(mu_a, mu_b, mu_c, tau_a, tau_b, tau_c) {
  pr_ord = function(ord) {
    
    mu_ = unname(unlist(mget(paste('mu', ord, sep = '_'), inherits = TRUE)))
    var_ = 1 / unname(unlist(mget(paste('tau', ord, sep = '_'), inherits = TRUE)))
    
    muz = c(mu_[2] - mu_[1], mu_[3] - mu_[2])
    varz = c(var_[1] + var_[2], var_[2] + var_[3])
    
    pmvnorm(
      c(-Inf, -Inf), 
      c(0, 0), 
      mean = muz, 
      sigma = rbind(c(varz[1], -var_[2]), c(-var_[2], varz[2]))
    )
  }
  
  return(
    c(pr_ord(c('a', 'b', 'c')), 
      pr_ord(c('a', 'c', 'b')), 
      pr_ord(c('b', 'a', 'c')), 
      pr_ord(c('b', 'c', 'a')), 
      pr_ord(c('c', 'a', 'b')), 
      pr_ord(c('c', 'b', 'a'))
    )
  )
}
```

```{r evpi3heu}
evpi3heu = function(mu_a, mu_b, mu_c, tau_a, tau_b, tau_c, mp) {
  
  jps = calc_jp(mu_a, mu_b, mu_c, tau_a, tau_b, tau_c)
  
  E_pri_uA = sum(jps * c(1, 1, mp, 0, mp, 0))
  E_pri_uB = sum(jps * c(mp, 0, 1, 1, 0, mp))
  E_pri_uC = sum(jps * c(0, mp, 0, mp, 1, 1))
  
  1 - pmax(E_pri_uA, E_pri_uB, E_pri_uC)
  
}
```

```{r evsi3heu}
evsi3heu = function(mu_a, mu_b, mu_c, tau_a, tau_b, tau_c, sigma2, N, p, mp) {
  upd_tau = function(sigma2, n, tau) {
    tau + (n / sigma2) 
  }
  sapply(
    N, 
    function(N) {
      jps = calc_jp(mu_a, mu_b, mu_c, tau_a, tau_b, tau_c)
       
      E_pri_uA = sum(jps * c(1, 1, mp, 0, mp, 0))
      E_pri_uB = sum(jps * c(mp, 0, 1, 1, 0, mp))
      E_pri_uC = sum(jps * c(0, mp, 0, mp, 1, 1))
       
      tau_a = upd_tau(sigma2, N * p[1], tau_a)
      tau_b = upd_tau(sigma2, N * p[2], tau_b)
      tau_c = upd_tau(sigma2, N * (1 - p[1] - p[2]), tau_c)
       
      jps = calc_jp(mu_a, mu_b, mu_c, tau_a, tau_b, tau_c)
       
      E_post_uA = sum(jps * c(1, 1, mp, 0, mp, 0))
      E_post_uB = sum(jps * c(mp, 0, 1, 1, 0, mp))
      E_post_uC = sum(jps * c(0, mp, 0, mp, 1, 1))
       
      pmax(E_post_uA, E_post_uB, E_post_uC) - pmax(E_pri_uA, E_pri_uB, E_pri_uC)
     }
  )  
}
```

```{r evsi3opt}
evsi3opt = 
  function(mu_a, mu_b, mu_c, tau_a, tau_b, tau_c, sigma2, N, f, mp = 0.5) {
    simplify2array(
      mclapply(
        N, 
        function(N) {   
          x = 
            constrOptim(
              c(1/3, 1/3),
              function(p) {
                f(mu_a, mu_b, mu_c, tau_a, tau_b, tau_c, sigma2, N, p, mp)
              }, 
              NULL,
              rbind(c(1, 0), c(0, 1), c(-1, -1)),
              c(0, 0, -1),
              control = list(fnscale = -1)        
            )
          return(c(x$value, x$par[1], x$par[2], 1 - x$par[1] - x$par[2]))
        },
        mc.cores = 20
      )
    )
  }
```

```{r evsi2heuplot}
local({
  x = seq(0.0001, 10, length.out = 50)
  y = evsi3opt(2, .5, 0, 1.25^-2, .8^-2, .75^-2, 1, x, evsi3heu, .5)
  plot.new()
  plot.window(xlim = c(0, 10), ylim = 0:1, xaxs = 'i')
  box()
  axis(1)
  axis(2, 0:5/5, las = 1)
  mtext("N", 1, 3)
  mtext("p", 2, 3)
  points(x, y[2,], type = "l", lty = 1)
  points(x, y[3,], type = "l", lty = 2)
  points(x, y[4,], type = "l", lty = 3)
})
```

```{r evsi2sim, eval = FALSE}
system("julia evsi3sim.jl &")
```

```{r evsi3simplot}
local({
  y = read.csv("evsi3sim.csv", header = FALSE)
  y = as.matrix(y)[,-1:-3]
  x = seq(.0001, 10, length.out = 50)[-1:-3]
  plot(x, y[1, ], ylim = 0:1, type = "n", las = 1, xlab = "N", ylab = "p")
  lines(smooth.spline(x, y[1,]),lty = 1)
  lines(smooth.spline(x, y[2,]), lty = 2)
  lines(smooth.spline(x, 1 - (y[1, ] + y[2, ])), lty = 3)
})
```
